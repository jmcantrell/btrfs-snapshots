#!/usr/bin/env bash

set -eu
shopt -s nullglob

name=${0##*/}

export LIB_DIR=${BTRFS_SNAPSHOTS_LIB_DIR:-/usr/local/lib/$name}
export PROFILES_DIR=${BTRFS_SNAPSHOTS_PROFILES_DIR:-/usr/local/etc/$name/profiles.d}
export DEFAULTS_FILE=${BTRFS_SNAPSHOTS_DEFAULTS_FILE:-/usr/local/etc/$name/defaults.conf}

. "$LIB_DIR"/init.sh

declare -a profile_names=()

while getopts ":hnp:" option; do
    case $option in
    p) profile_names+=("$OPTARG") ;;
    h)
        info "$TEXT_USAGE"
        exit 0
        ;;
    *) die "$TEXT_INVALID" NAME=option VALUE="$OPTARG" ;;
    esac
done && shift $((OPTIND - 1))

action=${1:-list}

case $action in
create | prune | list) ;;
*) die "$TEXT_INVALID" NAME=action VALUE="$action" ;;
esac

declare -a profile_files

if ((${#profile_names[@]} > 0)); then
    profile_files=()
    for profile_name in "${profile_names[@]}"; do
        profile_files+=("$PROFILES_DIR/$profile_name.conf")
    done
else
    profile_files=("$PROFILES_DIR"/*.conf)
fi

declare -A profiles_seen=()

for PROFILE_FILE in "${profile_files[@]}"; do
    export PROFILE_FILE

    if [[ -v profiles_seen[$PROFILE_FILE] ]]; then
        continue
    fi

    profiles_seen[$PROFILE_FILE]=1

    if ! load_profile; then
        die "$TEXT_PROFILE_FAILED" PROFILE_FILE
    fi

    if ! "$action"; then
        die "$TEXT_ACTION_FAILED" ACTION="$action"
    fi
done
