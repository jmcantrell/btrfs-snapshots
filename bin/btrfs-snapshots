#!/usr/bin/env bash

set -eu
shopt -s nullglob

name=${0##*/}

export LIB_DIR=${BTRFS_SNAPSHOTS_LIB_DIR:-/usr/local/lib/$name}
export CONFIG_DIR=${BTRFS_SNAPSHOTS_CONFIG_DIR:-/usr/local/etc/$name}

. "$LIB_DIR"/init.sh

profile_names=()

while [[ -v 1 ]]; do
    case $1 in
    -h | -\? | --help)
        printf "$TEXT_USAGE\n"
        exit
        ;;

    -C | --config-dir)
        if [[ ! -v 2 ]]; then
            printf "$TEXT_OPTION_MISSING_ARGUMENT\n" "$1" >&2
            exit 1
        fi
        CONFIG_DIR=$2
        shift
        ;;
    --config-dir=)
        printf "$TEXT_OPTION_MISSING_ARGUMENT\n" "${1%%=*}" >&2
        exit 1
        ;;
    --config-dir=?*)
        CONFIG_DIR=${1##*=}
        ;;

    -p | --profile)
        if [[ ! -v 2 ]]; then
            printf "$TEXT_OPTION_MISSING_ARGUMENT\n" "$1" >&2
            exit 1
        fi
        profile_names+=("$2")
        shift
        ;;
    --profile=)
        printf "$TEXT_OPTION_MISSING_ARGUMENT\n" "${1%%=*}" >&2
        exit 1
        ;;
    --profile=?*)
        profile_names+=("${1##*=}")
        ;;

    --)
        shift
        break
        ;;

    -?*)
        printf "$TEXT_OPTION_INVALID\n" "$1" >&2
        exit 1
        ;;

    *) break ;;
    esac

    shift
done

action=${1:-list}
[[ -v 1 ]] && shift

case $action in
create | prune | list) ;;
*)
    printf "$TEXT_ACTION_INVALID\n" "$action" >&2
    exit 1
    ;;
esac

profile_dir=$CONFIG_DIR/profile.d

declare -a profile_files

if ((${#profile_names[@]} > 0)); then
    profile_files=()
    for profile_name in "${profile_names[@]}"; do
        profile_files+=("$profile_dir/$profile_name.conf")
    done
else
    profile_files=("$profile_dir"/*.conf)
fi

declare -A profiles_seen=()

for PROFILE_FILE in "${profile_files[@]}"; do
    export PROFILE_FILE

    PROFILE_NAME=${PROFILE_FILE##*/}
    export PROFILE_NAME=${PROFILE_NAME%.conf}

    if [[ -v profiles_seen[$PROFILE_FILE] ]]; then
        continue
    fi

    profiles_seen[$PROFILE_FILE]=1

    if ! load_profile; then
        printf "$TEXT_PROFILE_LOAD_FAILED\n" "$PROFILE_NAME" >&2
        exit 1
    fi

    if ! "$action"; then
        printf "$TEXT_ACTION_FAILED\n" "$action" >&2
        exit 1
    fi
done
