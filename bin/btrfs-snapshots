#!/usr/bin/env bash

set -eu
shopt -s nullglob

bin_name=${0##*/}
export LIB_DIR=${BTRFS_SNAPSHOTS_LIB_DIR:-/usr/local/lib/$bin_name}
export CONFIG_FILE=${BTRFS_SNAPSHOTS_CONFIG_FILE:-/usr/local/etc/$bin_name.conf}

. "$LIB_DIR"/init.sh

if [[ -r $CONFIG_FILE ]] && ! . "$CONFIG_FILE"; then
    die "$TEXT_CONFIG_FAILED"
fi

declare -a profile_names=()

while getopts ":hnp:" option; do
    case $option in
    n) export DRY_RUN=1 ;;
    p) profile_names+=("$OPTARG") ;;
    h) finish "$TEXT_USAGE" ;;
    *) die "$TEXT_INVALID" NAME=option VALUE="$OPTARG" ;;
    esac
done && shift $((OPTIND - 1))

action=${1:-list}

case $action in
create | prune | list) ;;
*) die "$TEXT_INVALID" NAME=action VALUE="$action" ;;
esac

profile_dir=${BTRFS_SNAPSHOTS_PROFILE_DIR:-/usr/local/etc/$bin_name.d}

declare -a profile_files

if ((${#profile_names[@]} > 0)); then
    profile_files=()
    for profile_name in "${profile_names[@]}"; do
        profile_files+=("$profile_dir/$profile_name.conf")
    done
else
    profile_files=("$profile_dir"/*.conf)
fi

declare -A profiles_seen=()

for PROFILE_FILE in "${profile_files[@]}"; do
    export PROFILE_FILE

    if [[ -v profiles_seen[$PROFILE_FILE] ]]; then
        continue
    fi

    profiles_seen[$PROFILE_FILE]=1

    if ! load_profile; then
        die "$TEXT_PROFILE_FAILED" PROFILE_FILE
    fi

    if ! "$action"; then
        die "$TEXT_ACTION_FAILED" ACTION="$action"
    fi
done
