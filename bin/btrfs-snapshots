#!/usr/bin/env bash

set -eu
shopt -s nullglob

name=${0##*/}

export LIB_DIR=${BTRFS_SNAPSHOTS_LIB_DIR:-/usr/local/lib/$name}
export CONFIG_DIR=${BTRFS_SNAPSHOTS_CONFIG_DIR:-/usr/local/etc/$name}

. "$LIB_DIR"/init.sh

usage() {
    printf "%s\n" "$TEXT_USAGE"
    exit
}

invalid_option() {
    warning "$TEXT_INVALID" option "$1"
}

missing_optarg() {
    die "$TEXT_OPTION_MISSING_ARGUMENT" "$1"
}

profile_names=()

while [[ -v 1 ]]; do
    case $1 in
    -h | -\? | --help) usage ;;

    -C | --config-dir)
        [[ -v 2 ]] || missing_optarg "$1"
        CONFIG_DIR=$2
        shift
        ;;
    --config-dir=)
        missing_optarg "${1%%=*}"
        ;;
    --config-dir=?*)
        CONFIG_DIR=${1##*=}
        ;;

    -p | --profile)
        [[ -v 2 ]] || missing_optarg "$1"
        profile_names+=("$2")
        shift
        ;;
    --profile=)
        missing_optarg "${1%%=*}"
        ;;
    --profile=?*)
        profile_names+=("${1##*=}")
        ;;

    --)
        shift
        break
        ;;

    -?*) invalid_option "$1" ;;

    *) break ;;
    esac

    shift
done

action=${1:-list}
[[ -v 1 ]] && shift

case $action in
create | prune | list) ;;
*) die "$TEXT_INVALID" action "$action" ;;
esac

profile_dir=$CONFIG_DIR/profile.d

declare -a profile_files

if ((${#profile_names[@]} > 0)); then
    profile_files=()
    for profile_name in "${profile_names[@]}"; do
        profile_files+=("$profile_dir/$profile_name.conf")
    done
else
    profile_files=("$profile_dir"/*.conf)
fi

declare -A profiles_seen=()

for PROFILE_FILE in "${profile_files[@]}"; do
    export PROFILE_FILE

    if [[ -v profiles_seen[$PROFILE_FILE] ]]; then
        continue
    fi

    profiles_seen[$PROFILE_FILE]=1

    if ! load_profile; then
        die "$TEXT_PROFILE_LOAD_FAILED" "$PROFILE_FILE"
    fi

    if ! "$action"; then
        die "$TEXT_ACTION_FAILED" "$action"
    fi
done
