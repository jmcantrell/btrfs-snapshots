#!/usr/bin/env bash

set -eu
shopt -s nullglob

name=${0##*/}

export LIB_DIR=${BTRFS_SNAPSHOTS_LIB_DIR:-/usr/local/lib/$name}
export ETC_DIR=${BTRFS_SNAPSHOTS_ETC_DIR:-/usr/local/etc/$name}

. "$LIB_DIR"/init.sh

profile_names=()

while getopts ":C:p:h" option; do
    case $option in
    C) export ETC_DIR=$OPTARG ;;
    p) profile_names+=("$OPTARG") ;;
    h)
        info "$TEXT_USAGE"
        exit 0
        ;;
    *) die "$TEXT_INVALID" option "$OPTARG" ;;
    esac
done && shift $((OPTIND - 1))

action=${1:-list}

profile_dir=$ETC_DIR/profile.d

case $action in
create | prune | list) ;;
*) die "$TEXT_INVALID" action "$action" ;;
esac

declare -a profile_files

if ((${#profile_names[@]} > 0)); then
    profile_files=()
    for profile_name in "${profile_names[@]}"; do
        profile_files+=("$profile_dir/$profile_name.conf")
    done
else
    profile_files=("$profile_dir"/*.conf)
fi

declare -A profiles_seen=()

for PROFILE_FILE in "${profile_files[@]}"; do
    export PROFILE_FILE

    if [[ -v profiles_seen[$PROFILE_FILE] ]]; then
        continue
    fi

    profiles_seen[$PROFILE_FILE]=1

    if ! load_profile; then
        die "$TEXT_PROFILE_LOAD_FAILED" "$PROFILE_FILE"
    fi

    if ! "$action"; then
        die "$TEXT_ACTION_FAILED" "$action"
    fi
done
