#!/usr/bin/env bash

set -euo pipefail
shopt -s nullglob

name=${0##*/}

export LIB_DIR=${BTRFS_SNAPSHOTS_LIB_DIR:-/usr/local/lib/$name}
export CONFIG_DIR=${BTRFS_SNAPSHOTS_CONFIG_DIR:-/usr/local/etc/$name}

. "$LIB_DIR"/init.bash

profile_names=()

while [[ -v 1 ]]; do
    case $1 in
    -h | -\? | --help)
        printf "$TEXT_USAGE\n"
        exit
        ;;

    -C | --config-dir)
        if [[ ! -v 2 ]]; then
            printf "$TEXT_OPTION_MISSING_ARGUMENT\n" "$1" >&2
            exit 1
        fi
        CONFIG_DIR=$2
        shift
        ;;
    --config-dir=)
        printf "$TEXT_OPTION_MISSING_ARGUMENT\n" "${1%%=*}" >&2
        exit 1
        ;;
    --config-dir=?*)
        CONFIG_DIR=${1##*=}
        ;;

    -p | --profile)
        if [[ ! -v 2 ]]; then
            printf "$TEXT_OPTION_MISSING_ARGUMENT\n" "$1" >&2
            exit 1
        fi
        profile_names+=("$2")
        shift
        ;;
    --profile=)
        printf "$TEXT_OPTION_MISSING_ARGUMENT\n" "${1%%=*}" >&2
        exit 1
        ;;
    --profile=?*)
        profile_names+=("${1##*=}")
        ;;

    --)
        shift
        break
        ;;

    -?*)
        printf "$TEXT_OPTION_INVALID\n" "$1" >&2
        exit 1
        ;;

    *) break ;;
    esac

    shift
done

action=${1:-list}

case $action in
create | prune | list) ;;
*)
    printf "$TEXT_ACTION_INVALID\n" "$action" >&2
    exit 1
    ;;
esac

export PROFILES_DIR=$CONFIG_DIR/profile.d
export DEFAULTS_FILE=$CONFIG_DIR/defaults.conf

declare -a profile_files

if ((${#profile_names[@]} > 0)); then
    profile_files=()
    while IFS= read -r -d '' profile_file; do
        if [[ ! -f $profile_file ]]; then
            printf "$TEXT_PROFILE_MISSING\n" "$profile_file" >&2
            exit 1
        fi
        profile_files+=("$profile_file")
    done < <(sort -zu < <(printf "$PROFILES_DIR/%s.conf\0" "${profile_names[@]}"))
else
    profile_files=("$PROFILES_DIR"/*.conf)
fi

declare -A snapshots_seen

for profile_file in "$PROFILES_DIR"/*.conf; do
    if ! load_profile "$profile_file"; then
        printf "$TEXT_PROFILE_LOAD_FAILED\n" "$profile_file" >&2
        exit 1
    fi

    if [[ -v snapshots_seen[$SNAPSHOTS] ]]; then
        printf "$TEXT_PROFILE_SNAPSHOTS_NOT_UNIQUE\n" "$SNAPSHOTS" >&2
        exit 1
    fi

    snapshots_seen[$SNAPSHOTS]=1
done

for profile_file in "${profile_files[@]}"; do
    load_profile "$profile_file"

    if ! "$action"; then
        printf "$TEXT_ACTION_FAILED\n" "$action" >&2
        exit 1
    fi
done
