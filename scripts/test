#!/usr/bin/env bash

set -euo pipefail

self_name=${0##*/}

usage="Run tests.

Usage:
    $self_name --help|-h
    $self_name [OPTIONS] [PATTERN...]

Options:
    -i    match PATTERN case-insensitively
    -v    print every test that's run, regardless of failures

Arguments:
    PATTERN    only test files matching PATTERN
"

if (($# > 0)) && [[ $1 == --help || $1 == -h ]]; then
    printf "%s\n" "$usage"
    exit
fi

unset verbose
find_opt="path"

while getopts "iv" opt; do
    case $opt in
    v) verbose=1 ;;
    i) find_opt="ipath" ;;
    *) exit 2 ;;
    esac
done
shift $((OPTIND - 1))

find_opts=()

if (($# > 1)); then
    find_opts+=("\\(")
    for pattern in "$@"; do
        find_opts+=(-"$find_opt" "*$pattern*" -o)
    done
    unset "find_opts[-1]"
    find_opts+=("\\)")
elif (($# > 0)); then
    find_opts+=(-"$find_opt" "*$1*")
fi

find "$PWD"/tests/{unit,integration} -type f -executable "${find_opts[@]}" -print0 |
    parallel ${verbose:+-v} --shuf --jobs=0 --null ./scripts/test1
