#!/usr/bin/env bash

set -eu

. "$LIB_DIR"/init.sh
. "$TESTS_LIB_DIR"/init.sh

btrfs_subvolume() {
    local cmd=$1
    shift

    case $cmd in
    snapshot) btrfs_subvolume_snapshot "$@" ;;
    delete) btrfs_subvolume_delete "$@" ;;
    *) die "unexpected btrfs subvolume command: $cmd" ;;
    esac
}

btrfs_subvolume_snapshot() {
    local options=$1
    local subvolume=$2
    local snapshot=$3

    if [[ $options != -r ]]; then
        die "command should create a readonly snapshot"
    fi

    if [[ ! -d $subvolume ]]; then
        die "subvolume should be a directory"
    fi

    if [[ -d $snapshot ]]; then
        die "snapshot should not already exist"
    fi

    cp -rT "$subvolume" "$snapshot" >&2
}

btrfs_subvolume_delete() {
    local snapshot=$1

    if [[ ! -d $snapshot ]]; then
        die "snapshot should be a directory"
    fi

    rm -rf "$snapshot" >&2
}

cmd=$1
shift

case $cmd in
subvolume) btrfs_subvolume "$@" ;;
*) die "unexpected btrfs command: $cmd" ;;
esac
