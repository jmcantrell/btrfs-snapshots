#!/usr/bin/env bash

# A fake implementation of the `btrfs` command.

set -euo pipefail

do_subvolume() {
    local action_name=${1:?missing action}
    shift

    case $action_name in
    snapshot | delete) do_subvolume_"$action_name" "$@" ;;
    *)
        printf "unexpected btrfs subvolume command: %s\n" "$action_name" >&2
        exit 1
        ;;
    esac
}

do_subvolume_snapshot() {
    # Skip any options.
    while [[ ${1:-} == -* ]]; do
        shift
    done

    local subvolume=${1:?missing subvolume}
    local snapshot=${2:?missing snapshot}

    printf "fake btrfs subvolume snapshot %s %s\n" "$subvolume" "$snapshot"

    cp -rT "$subvolume" "$snapshot" >&2
}

do_subvolume_delete() {
    local snapshot=${1:?missing snapshot}

    printf "fake btrfs subvolume delete %s\n" "$snapshot"

    rm -r "$snapshot"
}

action_name=${1:?missing action}
shift

case $action_name in
subvolume) do_"$action_name" "$@" ;;
*)
    printf "unexpected btrfs command: %s\n" "$action_name" >&2
    exit 1
    ;;
esac
