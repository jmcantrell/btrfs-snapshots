#!/usr/bin/env bash

# A fake implementation of the btrfs functionality used in the tests.
# Simulates the same messages. Operates on regular directories instead.

set -eu

. "$LIB_DIR"/init.sh
. "$TESTS_LIB_DIR"/init.sh

btrfs_subvolume() {
    local cmd=$1
    shift

    case $cmd in
    snapshot) btrfs_subvolume_snapshot "$@" ;;
    delete) btrfs_subvolume_delete "$@" ;;
    *) die "Unexpected btrfs subvolume command: $cmd" ;;
    esac
}

btrfs_subvolume_snapshot() {
    local options=$1
    local subvolume=$2
    local snapshot=$3

    if [[ $options != -r ]]; then
        die "Btrfs command should be using -r to create a read-only snapshot"
    fi

    if [[ ! -d $subvolume ]]; then
        die "Subvolume path should be a directory"
    fi

    if [[ -e $snapshot ]]; then
        die "Snapshot path should not already exist"
    fi

    info "$TEXT_BTRFS_CREATE" SUBVOLUME="$subvolume" SNAPSHOT="$snapshot"

    cp -rT "$subvolume" "$snapshot" >&2
}

btrfs_subvolume_delete() {
    local snapshot=$1

    if [[ ! -d $snapshot ]]; then
        die "Snapshot path should be a directory"
    fi

    info "$TEXT_BTRFS_DELETE" SNAPSHOT="$snapshot"

    rm -rf "$snapshot"
}

cmd=$1
shift

case $cmd in
subvolume) btrfs_subvolume "$@" ;;
*) die "Unexpected btrfs command: $cmd" ;;
esac
