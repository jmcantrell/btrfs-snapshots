#!/usr/bin/env bash

# Show that `list` will print all snapshot paths.

set -euo pipefail

. "$LIB_DIR"/init.bash
. "$TESTS_LIB_DIR"/init.bash

export SNAPSHOTS=$TEMP_DIR/snapshots

timestamp=2000-01-01T00:00:00Z

# Add some invalid paths (that should not be returned):
mkdir -p "$SNAPSHOTS"/foo/bar/baz    # nested and incorrectly named directory
mkdir -p "$SNAPSHOTS/foo/$timestamp" # nested and correctly named directory
touch "$SNAPSHOTS/$timestamp"        # shallow and correctly named file

# Add some valid snapshot paths:
while read -r timestamp_step; do
    snapshot=$SNAPSHOTS/$timestamp_step
    expected+=("$snapshot")
    mkdir -p "$snapshot"
done < <(timestamp_seq "$TIMESTAMP" hour 24)

readarray -t actual < <(do_list)

# Ensure the correct number of snapshots are returned.
assert_equal "${#actual[@]}" "${#expected[@]}"

# Ensure the correct snapshot paths are returned.
for ((i = 0; i < ${#actual[@]}; i++)); do
    assert_equal "${actual[i]}" "${expected[i]}"
done
