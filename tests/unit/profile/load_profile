#!/usr/bin/env bash

# Show that a profile can be loaded under normal circumstances.

set -eu

. "$LIB_DIR"/init.sh
. "$TESTS_LIB_DIR"/init.sh

export PROFILE_FILE=$TEMP_DIR/profile

subvolume=$TEMP_DIR/$RANDOM
snapshots=$TEMP_DIR/$RANDOM
limits=()

cat >"$PROFILE_FILE" <<-EOF
SUBVOLUME=$subvolume
SNAPSHOTS=$snapshots
EOF

for event_name in "${EVENT_NAMES[@]}"; do
    limit=$((1 + RANDOM))
    limits+=("$limit")
    echo "$(get_limit_variable "$event_name")=$limit" >>"$PROFILE_FILE"
done

assert_success assert_no_output \
    load_profile

# shellcheck disable=SC2153
assert_equal "$SUBVOLUME" "$subvolume"
# shellcheck disable=SC2153
assert_equal "$SNAPSHOTS" "$snapshots"

for i in "${!EVENT_NAMES[@]}"; do
    assert_equal "$(get_limit "${EVENT_NAMES[i]}")" "${limits[i]}"
done
