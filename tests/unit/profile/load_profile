#!/usr/bin/env bash

# Show that a profile can be loaded under normal circumstances.

set -eu

. "$LIB_DIR"/init.sh
. "$TESTS_LIB_DIR"/init.sh

subvolume=$TEMP_DIR/$RANDOM
snapshots=$TEMP_DIR/$RANDOM
profile_file=$TEMP_DIR/profile
limits=()

cat >"$profile_file" <<-EOF
SUBVOLUME=$subvolume
SNAPSHOTS=$snapshots
EOF

for event_name in "${EVENT_NAMES[@]}"; do
    limit=$((1 + RANDOM))
    limits+=("$limit")
    echo "LIMIT_${event_name@U}=$limit" >>"$profile_file"
done

export PROFILE_FILE=$profile_file
export DEFAULTS_FILE=/does/not/matter

assert_success assert_no_output \
    load_profile

# shellcheck disable=SC2153
assert_equal "$SUBVOLUME" "$subvolume"
# shellcheck disable=SC2153
assert_equal "$SNAPSHOTS" "$snapshots"

for i in "${!EVENT_NAMES[@]}"; do
    assert_equal "$(get_limit "${EVENT_NAMES[i]}")" "${limits[i]}"
done
